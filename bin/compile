#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

if [ "$STACK" != "heroku-16" ] && [ "$STACK" != "heroku-18" ]; then
	echo "Need heroku-16 or heroku-18 stack"
	exit 1
fi

### Configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

mkdir -p $BUILD_DIR/.profile.d
cp $BP_DIR/profile/* $BUILD_DIR/.profile.d/

### Load dependencies
source $BP_DIR/lib/utils

export_env_dir "$ENV_DIR"
export NUGET_XMLDOC_MODE=${NUGET_XMLDOC_MODE:-skip}
export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=${DOTNET_SKIP_FIRST_TIME_EXPERIENCE:-1}
export DOTNET_CLI_TELEMETRY_OPTOUT=${DOTNET_CLI_TELEMETRY_OPTOUT:-1}

DOTNET_SDK_VERSION=${DOTNET_SDK_VERSION:-2.1.500}
DOTNET_RUNTIME_VERSION=${DOTNET_RUNTIME_VERSION:-2.1.6}

echo "Installing dotnet"
install_dotnet $BUILD_DIR $CACHE_DIR $DOTNET_SDK_VERSION $DOTNET_RUNTIME_VERSION

export PATH="${BUILD_DIR}/.heroku/dotnet:${PATH}"

cd $BUILD_DIR

echo "BUILD_DIR:  ${BUILD_DIR:-}" | indent
echo "PATH:  ${PATH:-}" | indent
echo "PROJECT_NAME_WORKER:  ${PROJECT_NAME_WORKER:-}" | indent
echo "PROJECT_NAME_WEB:  ${PROJECT_NAME_WEB:-}" | indent
echo "PROJECT_FILE_NAME_WORKER:  ${PROJECT_FILE_NAME_WORKER:-}" | indent
echo "PROJECT_FILE_NAME_WEB:  ${PROJECT_FILE_NAME_WEB:-}" | indent

if [ -z ${PROJECT_FILE_PATH_WEB:-} ]; then
	PROJECT_FILE_PATH_WEB=$(x=$(dirname $(find ${BUILD_DIR} -maxdepth 5 -iname Startup.cs | head -1)); while [[ "$x" =~ $BUILD_DIR ]] ; do find "$x" -maxdepth 1 -name ${PROJECT_FILE_NAME_WEB}.csproj; x=`dirname "$x"`; done)
	echo "PROJECT_FILE_PATH_WEB set to:  ${PROJECT_FILE_PATH_WEB:-}" | indent
fi

if [ -z ${PROJECT_FILE_PATH_WORKER:-} ]; then
	PROJECT_FILE_PATH_WORKER=$(x=$(dirname $(find ${BUILD_DIR} -maxdepth 5 -iname Startup.cs | head -1)); while [[ "$x" =~ $BUILD_DIR ]] ; do find "$x" -maxdepth 1 -name ${PROJECT_FILE_NAME_WORKER}.csproj; x=`dirname "$x"`; done)
	echo "PROJECT_FILE_PATH_WORKER set to:  ${PROJECT_FILE_PATH_WORKER:-}" | indent
fi


echo "PROJECT_FILE_PATH_WEB:  ${PROJECT_FILE_PATH_WEB:-}" | indent
echo "PROJECT_FILE_PATH_WORKER:  ${PROJECT_FILE_PATH_WORKER:-}" | indent

if [ -z ${PROJECT_NAME_WEB:-} ]; then
	PROJECT_NAME_WEB=$(basename ${PROJECT_FILE_PATH_WEB%.*})
fi

if [ -z ${PROJECT_NAME_WORKER:-} ]; then
	PROJECT_NAME_WORKER=$(basename ${PROJECT_FILE_PATH_WORKER%.*})
fi

if [ -n "$(cat $PROJECT_NAME_WEB | grep 'netcoreapp2.0')" ]; then
	topic "WARNING"
	echo "For netcoreapp2.0 use https://github.com/jincod/dotnetcore-buildpack#v2.1.200" | indent
	echo "More info https://github.com/jincod/dotnetcore-buildpack/issues/44" | indent
fi

export NUGET_PACKAGES="${CACHE_DIR}/nuget/cache"

echo "publish ${PROJECT_NAME_WEB}"
dotnet publish $PROJECT_FILE_NAME_WEB --output ${BUILD_DIR}/heroku_output --configuration Release --runtime linux-x64

echo "publish ${PROJECT_NAME_WORKER}"
dotnet publish $PROJECT_FILE_NAME_WORKER --output ${BUILD_DIR}/heroku_output --configuration Release --runtime linux-x64

if [ ! -f ${BUILD_DIR}/Procfile ]; then
	cat << EOT >> ${BUILD_DIR}/Procfile
	web: cd \$HOME/heroku_output && ./${PROJECT_NAME_WEB}
	worker: cd \$HOME/heroku_output && ./${PROJECT_NAME_WORKER}
	echo "Web and worker started" | indent
EOT
else
	topic "WARNING"
	echo "Be careful with custom Procfile" | indent
fi
